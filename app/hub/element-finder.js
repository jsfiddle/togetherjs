(function () {
  var TowTruck = window.TowTruck;
  var assert = TowTruck.assert;

  TowTruck.elementLocation = function (el) {
    if (el[0]) {
      // a jQuery element
      el = el[0];
    }
    if (el.id) {
      return "#" + el.id;
    }
    if (el.tagName == "BODY") {
      return "body";
    }
    if (el.tagName == "HEAD") {
      return "head";
    }
    var parent = el.parentNode;
    var parentLocation = TowTruck.elementLocation(parent);
    if (! parent) {
      throw "No locatable parent found";
    }
    var children = parent.childNodes;
    var index = 0;
    for (var i=0; i<children.length; i++) {
      if (children[i] == el) {
        break;
      }
      if (children[i].nodeType == document.ELEMENT_NODE) {
        if (children[i].className.indexOf("towtruck") != -1) {
          // Don't count our UI
          continue;
        }
        // Don't count text or comments
        index++;
      }
    }
    return parentLocation + ":nth-child(" + (index+1) + ")";
  };

  TowTruck.CannotFind = TowTruck.Class({
    constructor: function CannotFind(location, reason, context) {
      this.prefix = "";
      this.location = location;
      this.reason = reason;
      this.context = context;
    },
    toString: function () {
      return (
        "[CannotFind " + this.prefix +
          "(" + this.location + "): " +
          this.reason + " in " +
          TowTruck.elementLocation(this.context) + "]");
    }
  });

  TowTruck.findElement = function (loc, container) {
    // FIXME: should this all just be done with document.querySelector()?
    // But no!  We can't ignore towtruck elements with querySelector.
    // But maybe!  We *could* make towtruck elements less obtrusive?
    container = container || document;
    var el, rest;
    if (loc.indexOf("body") === 0) {
      el = document.body;
      try {
        return TowTruck.findElement(loc.substr(("body").length), el);
      } catch (e) {
        if (e instanceof TowTruck.CannotFind) {
          e.prefix = "body" + e.prefix;
        }
        throw e;
      }
    } else if (loc.indexOf("head") === 0) {
      el = document.head;
      try {
        return TowTruck.findElement(loc.substr(("head").length), el);
      } catch (e) {
        if (e instanceof TowTruck.CannotFind) {
          e.prefix = "head" + e.prefix;
        }
        throw e;
      }
    } else if (loc.indexOf("#") === 0) {
      var id;
      loc = loc.substr(1);
      if (loc.indexOf(":") === -1) {
        id = loc;
        rest = "";
      } else {
        id = loc.substr(0, loc.indexOf(":"));
        rest = loc.substr(loc.indexOf(":"));
      }
      el = document.getElementById(id);
      if (! el) {
        throw TowTruck.CannotFind("#" + id, "No element by that id", container);
      }
      if (rest) {
        try {
          return TowTruck.findElement(rest, el);
        } catch (e) {
          if (e instanceof TowTruck.CannotFind) {
            e.prefix = "#" + id + e.prefix;
          }
          throw e;
        }
      } else {
        return el;
      }
    } else if (loc.indexOf(":nth-child(") === 0) {
      loc = loc.substr((":nth-child(").length);
      if (loc.indexOf(")") == -1) {
        throw "Invalid location, missing ): " + loc;
      }
      var num = loc.substr(0, loc.indexOf(")"));
      num = parseInt(num, 10);
      var count = num;
      loc = loc.substr(loc.indexOf(")") + 1);
      var children = container.childNodes;
      el = null;
      for (var i=0; i<children.length; i++) {
        var child = children[i];
        if (child.nodeType == document.ELEMENT_NODE) {
          if (child.className.indexOf("towtruck") != -1) {
            continue;
          }
          count--;
          if (count === 0) {
            // this is the element
            el = child;
            break;
          }
        }
      }
      if (! el) {
        throw TowTruck.CannotFind(":nth-child(" + num + ")", "container only has " + (num - count) + " elements", container);
      }
      if (loc) {
        try {
          return TowTruck.findElement(loc, el);
        } catch (e) {
          if (e instanceof TowTruck.CannotFind) {
            e.prefix = ":nth-child(" + num + ")" + e.prefix;
          }
          throw e;
        }
      } else {
        return el;
      }
    } else {
      throw TowTruck.CannotFind(loc, "Malformed location", container);
    }
  };

})();
