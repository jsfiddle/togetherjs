<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <title>
      Mozilla Labs : TogetherJS
    </title>
    <meta name="viewport" content="width=320, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <meta name="description" content="Real time collaboration features for your website or app.">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../images/fav-icon.ico">

    <script src="../js/jquery-1.10.2.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/parallax.js"></script>
    <script src="../js/custom.js"></script>
    <script src="../js/scrollTo.js"></script>
    <script src="../js/scrollspy.js"></script>
    <script src="../js/waypoints.min.js"></script>
    <script src="../js/how-animations.js"></script>
    <script src="../togetherjs.js"></script>

    <!-- retina library -->
    <script src="../js/retina.js"></script>

    <script src="//mozorg.cdn.mozilla.net/tabzilla/tabzilla.js"></script>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-35433268-28']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>

    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.css" rel="stylesheet">
    <link href="../css/jumbotron.css" rel="stylesheet">
    <link href="../css/carousel.css" rel="stylesheet">
    <link href="../css/grid.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <link href="//mozorg.cdn.mozilla.net/media/css/tabzilla-min.css" rel="stylesheet" />

    
  <link rel="stylesheet" href="../css/docco.css">
  <script src="../js/source-code.js"></script>


    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js">
      </script>
    <![endif]-->
    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="../assets/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">

  </head>
  <body >
    <div class="navbar navbar-inverse navbar-fixed-top main-header" id="main-navbar">

      <!-- Tabzilla -->
      <a href="https://www.mozilla.org/" id="tabzilla">mozilla</a>

      <!-- start container -->
      <div class="container navbox">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand main-logo scrollnav" href=".././"></a>
          <a class="navbar-brand masthead-title" href=".././">TogetherJS</a>
        </div>

        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right main-nav">
            <li><a href=".././"  >Overview</a></li>
            <li><a href=".././docs/"  >Documentation</a></li>
            <li><a href="https://github.com/mozilla/togetherjs" target="_blank">Github</a></li>
            <li><a href="mailto:togetherjs@mozilla.com">Contact</a></li>
          </ul>
        </div><!--/.navbar-collapse -->

      </div>
    </div>


    

<div class="container">

    <section class="row" id="sourcecode">
      <div class="col-md-3" id="source-toc">
        <div class="panel" role="complementary" data-spy="affix" data-offset-top="200" id="sidenav">
          <div class="panel-heading">Source Code</div>
          <ul class="nav" id="sectionmenu">
            
              <li><a href="analytics.js.html">analytics</a></li>
            
              <li><a href="channels.js.html">channels</a></li>
            
              <li><a href="chat.js.html">chat</a></li>
            
              <li><a href="cursor.js.html">cursor</a></li>
            
              <li><a href="elementFinder.js.html">elementFinder</a></li>
            
              <li><a href="eventMaker.js.html">eventMaker</a></li>
            
              <li><a href="forms.js.html">forms</a></li>
            
              <li><a href="jqueryPlugins.js.html">jqueryPlugins</a></li>
            
              <li><a href="linkify.js.html">linkify</a></li>
            
              <li><a href="ot.js.html">ot</a></li>
            
              <li><a href="peers.js.html">peers</a></li>
            
              <li><a href="playback.js.html">playback</a></li>
            
              <li><a href="randomutil.js.html">randomutil</a></li>
            
              <li><a href="recorder.js.html">recorder</a></li>
            
              <li><a href="session.js.html">session</a></li>
            
              <li><a href="startup.js.html">startup</a></li>
            
              <li><a href="storage.js.html">storage</a></li>
            
              <li><a href="templates.js.html">templates</a></li>
            
              <li><a href="templating.js.html">templating</a></li>
            
              <li><a href="togetherjs.js.html">togetherjs</a></li>
            
              <li><a href="ui.js.html">ui</a></li>
            
              <li><a href="util.js.html">util</a></li>
            
              <li><a href="videos.js.html">videos</a></li>
            
              <li><a href="visibilityApi.js.html">visibilityApi</a></li>
            
              <li><a href="walkthrough.js.html">walkthrough</a></li>
            
              <li><a href="webrtc.js.html">webrtc</a></li>
            
              <li><a href="who.js.html">who</a></li>
            
              <li><a href="windowing.js.html">windowing</a></li>
            
          </ul>
        </div>
      </div>

      <div class="col-md-9" id="source-content">
        <h1>elementFinder.js</h1>
        
          <h4><p>Generates something like a CSS selector for an element, and finds said elements based on selectors.  A portable description of an element.</p>
</h4>
        

        <div class="small"><a href="https://github.com/mozilla/togetherjs/blob/develop/togetherjs/elementFinder.js">See this file on Github</a></div>

        <ul class="sections">
          
            <li id="section-0">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-0">&#182;</a>
                </div>
                
              </div>
              
                <div class="content"><div class='highlight'><pre><span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

define([<span class="string">"util"</span>, <span class="string">"jquery"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(util, $)</span> {</span>
  <span class="keyword">var</span> elementFinder = util.Module(<span class="string">"elementFinder"</span>);
  <span class="keyword">var</span> assert = util.assert;

  elementFinder.ignoreElement = <span class="function"><span class="keyword">function</span> <span class="title">ignoreElement</span><span class="params">(el)</span> {</span>
    <span class="keyword">if</span> (el <span class="keyword">instanceof</span> $) {
      el = el[<span class="number">0</span>];
    }
    <span class="keyword">while</span> (el) {
      <span class="keyword">if</span> ($(el).hasClass(<span class="string">"togetherjs"</span>)) {
        <span class="keyword">return</span> <span class="literal">true</span>;
      }
      el = el.parentNode;
    }
    <span class="keyword">return</span> <span class="literal">false</span>;
  };

  elementFinder.elementLocation = <span class="function"><span class="keyword">function</span> <span class="title">elementLocation</span><span class="params">(el)</span> {</span>
    assert(el !== <span class="literal">null</span>, <span class="string">"Got null element"</span>);
    <span class="keyword">if</span> (el <span class="keyword">instanceof</span> $) {</pre></div></div>
              
            </li>
          
            <li id="section-1">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-1">&#182;</a>
                </div>
                <p>a jQuery element</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      el = el[<span class="number">0</span>];
    }
    <span class="keyword">if</span> (el.id) {
      <span class="keyword">return</span> <span class="string">"#"</span> + el.id;
    }
    <span class="keyword">if</span> (el.tagName == <span class="string">"BODY"</span>) {
      <span class="keyword">return</span> <span class="string">"body"</span>;
    }
    <span class="keyword">if</span> (el.tagName == <span class="string">"HEAD"</span>) {
      <span class="keyword">return</span> <span class="string">"head"</span>;
    }
    <span class="keyword">if</span> (el === document) {
      <span class="keyword">return</span> <span class="string">"document"</span>;
    }
    <span class="keyword">var</span> parent = el.parentNode;
    <span class="keyword">if</span> (! parent) {
      console.warn(<span class="string">"elementLocation("</span>, el, <span class="string">") has null parent"</span>);
      <span class="keyword">throw</span> <span class="string">"No locatable parent found"</span>;
    }
    <span class="keyword">var</span> parentLocation = elementLocation(parent);
    <span class="keyword">var</span> children = parent.childNodes;
    <span class="keyword">var</span> index = <span class="number">0</span>;
    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;children.length; i++) {
      <span class="keyword">if</span> (children[i] == el) {
        <span class="keyword">break</span>;
      }
      <span class="keyword">if</span> (children[i].nodeType == document.ELEMENT_NODE) {
        <span class="keyword">if</span> (children[i].className.indexOf(<span class="string">"togetherjs"</span>) != -<span class="number">1</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-2">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-2">&#182;</a>
                </div>
                <p>Don&#39;t count our UI</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>          <span class="keyword">continue</span>;
        }</pre></div></div>
              
            </li>
          
            <li id="section-3">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-3">&#182;</a>
                </div>
                <p>Don&#39;t count text or comments</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        index++;
      }
    }
    <span class="keyword">return</span> parentLocation + <span class="string">":nth-child("</span> + (index+<span class="number">1</span>) + <span class="string">")"</span>;
  };

  elementFinder.CannotFind = util.Class({
    constructor: <span class="function"><span class="keyword">function</span> <span class="title">CannotFind</span><span class="params">(location, reason, context)</span> {</span>
      <span class="keyword">this</span>.prefix = <span class="string">""</span>;
      <span class="keyword">this</span>.location = location;
      <span class="keyword">this</span>.reason = reason;
      <span class="keyword">this</span>.context = context;
    },
    toString: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">var</span> loc;
      <span class="keyword">try</span> {
        loc = elementFinder.elementLocation(<span class="keyword">this</span>.context);
      } <span class="keyword">catch</span> (e) {
        loc = <span class="keyword">this</span>.context;
      }
      <span class="keyword">return</span> (
        <span class="string">"[CannotFind "</span> + <span class="keyword">this</span>.prefix +
          <span class="string">"("</span> + <span class="keyword">this</span>.location + <span class="string">"): "</span> +
          <span class="keyword">this</span>.reason + <span class="string">" in "</span> +
          loc + <span class="string">"]"</span>);
    }
  });

  elementFinder.findElement = <span class="function"><span class="keyword">function</span> <span class="title">findElement</span><span class="params">(loc, container)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-4">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-4">&#182;</a>
                </div>
                <p>FIXME: should this all just be done with document.querySelector()?
But no!  We can&#39;t ignore togetherjs elements with querySelector.
But maybe!  We <em>could</em> make togetherjs elements less obtrusive?</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    container = container || document;
    <span class="keyword">var</span> el, rest;
    <span class="keyword">if</span> (loc === <span class="string">"body"</span>) {
      <span class="keyword">return</span> document.body;
    } <span class="keyword">else</span> <span class="keyword">if</span> (loc === <span class="string">"head"</span>) {
      <span class="keyword">return</span> document.head;
    } <span class="keyword">else</span> <span class="keyword">if</span> (loc === <span class="string">"document"</span>) {
      <span class="keyword">return</span> document;
    } <span class="keyword">else</span> <span class="keyword">if</span> (loc.indexOf(<span class="string">"body"</span>) === <span class="number">0</span>) {
      el = document.body;
      <span class="keyword">try</span> {
        <span class="keyword">return</span> findElement(loc.substr((<span class="string">"body"</span>).length), el);
      } <span class="keyword">catch</span> (e) {
        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> elementFinder.CannotFind) {
          e.prefix = <span class="string">"body"</span> + e.prefix;
        }
        <span class="keyword">throw</span> e;
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (loc.indexOf(<span class="string">"head"</span>) === <span class="number">0</span>) {
      el = document.head;
      <span class="keyword">try</span> {
        <span class="keyword">return</span> findElement(loc.substr((<span class="string">"head"</span>).length), el);
      } <span class="keyword">catch</span> (e) {
        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> elementFinder.CannotFind) {
          e.prefix = <span class="string">"head"</span> + e.prefix;
        }
        <span class="keyword">throw</span> e;
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (loc.indexOf(<span class="string">"#"</span>) === <span class="number">0</span>) {
      <span class="keyword">var</span> id;
      loc = loc.substr(<span class="number">1</span>);
      <span class="keyword">if</span> (loc.indexOf(<span class="string">":"</span>) === -<span class="number">1</span>) {
        id = loc;
        rest = <span class="string">""</span>;
      } <span class="keyword">else</span> {
        id = loc.substr(<span class="number">0</span>, loc.indexOf(<span class="string">":"</span>));
        rest = loc.substr(loc.indexOf(<span class="string">":"</span>));
      }
      el = document.getElementById(id);
      <span class="keyword">if</span> (! el) {
        <span class="keyword">throw</span> elementFinder.CannotFind(<span class="string">"#"</span> + id, <span class="string">"No element by that id"</span>, container);
      }
      <span class="keyword">if</span> (rest) {
        <span class="keyword">try</span> {
          <span class="keyword">return</span> findElement(rest, el);
        } <span class="keyword">catch</span> (e) {
          <span class="keyword">if</span> (e <span class="keyword">instanceof</span> elementFinder.CannotFind) {
            e.prefix = <span class="string">"#"</span> + id + e.prefix;
          }
          <span class="keyword">throw</span> e;
        }
      } <span class="keyword">else</span> {
        <span class="keyword">return</span> el;
      }
    } <span class="keyword">else</span> <span class="keyword">if</span> (loc.indexOf(<span class="string">":nth-child("</span>) === <span class="number">0</span>) {
      loc = loc.substr((<span class="string">":nth-child("</span>).length);
      <span class="keyword">if</span> (loc.indexOf(<span class="string">")"</span>) == -<span class="number">1</span>) {
        <span class="keyword">throw</span> <span class="string">"Invalid location, missing ): "</span> + loc;
      }
      <span class="keyword">var</span> num = loc.substr(<span class="number">0</span>, loc.indexOf(<span class="string">")"</span>));
      num = parseInt(num, <span class="number">10</span>);
      <span class="keyword">var</span> count = num;
      loc = loc.substr(loc.indexOf(<span class="string">")"</span>) + <span class="number">1</span>);
      <span class="keyword">var</span> children = container.childNodes;
      el = <span class="literal">null</span>;
      <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;children.length; i++) {
        <span class="keyword">var</span> child = children[i];
        <span class="keyword">if</span> (child.nodeType == document.ELEMENT_NODE) {
          <span class="keyword">if</span> (child.className.indexOf(<span class="string">"togetherjs"</span>) != -<span class="number">1</span>) {
            <span class="keyword">continue</span>;
          }
          count--;
          <span class="keyword">if</span> (count === <span class="number">0</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-5">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-5">&#182;</a>
                </div>
                <p>this is the element</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            el = child;
            <span class="keyword">break</span>;
          }
        }
      }
      <span class="keyword">if</span> (! el) {
        <span class="keyword">throw</span> elementFinder.CannotFind(<span class="string">":nth-child("</span> + num + <span class="string">")"</span>, <span class="string">"container only has "</span> + (num - count) + <span class="string">" elements"</span>, container);
      }
      <span class="keyword">if</span> (loc) {
        <span class="keyword">try</span> {
          <span class="keyword">return</span> elementFinder.findElement(loc, el);
        } <span class="keyword">catch</span> (e) {
          <span class="keyword">if</span> (e <span class="keyword">instanceof</span> elementFinder.CannotFind) {
            e.prefix = <span class="string">":nth-child("</span> + num + <span class="string">")"</span> + e.prefix;
          }
          <span class="keyword">throw</span> e;
        }
      } <span class="keyword">else</span> {
        <span class="keyword">return</span> el;
      }
    } <span class="keyword">else</span> {
      <span class="keyword">throw</span> elementFinder.CannotFind(loc, <span class="string">"Malformed location"</span>, container);
    }
  };

  elementFinder.elementByPixel = <span class="function"><span class="keyword">function</span> <span class="params">(height)</span> {</span>
    <span class="comment">/* Returns {location: "...", offset: pixels}

       To get the pixel position back, you'd do:
         $(location).offset().top + offset
     */</span>
    <span class="function"><span class="keyword">function</span> <span class="title">search</span><span class="params">(start, height)</span> {</span>
      <span class="keyword">var</span> last = <span class="literal">null</span>;
      <span class="keyword">var</span> children = start.children();
      children.each(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        <span class="keyword">var</span> el = $(<span class="keyword">this</span>);
        <span class="keyword">if</span> (el.hasClass(<span class="string">"togetherjs"</span>) || el.css(<span class="string">"position"</span>) == <span class="string">"fixed"</span> || ! el.is(<span class="string">":visible"</span>)) {
          <span class="keyword">return</span>;
        }
        <span class="keyword">if</span> (el.offset().top &gt; height) {
          <span class="keyword">return</span> <span class="literal">false</span>;
        }
        last = el;
      });
      <span class="keyword">if</span> ((! children.length) || (! last)) {</pre></div></div>
              
            </li>
          
            <li id="section-6">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-6">&#182;</a>
                </div>
                <p>There are no children, or only inapplicable children</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> {
          location: elementFinder.elementLocation(start[<span class="number">0</span>]),
          offset: height - start.offset().top,
          absoluteTop: height,
          documentHeight: $(document).height()
        };
      }
      <span class="keyword">return</span> search(last, height);
    }
    <span class="keyword">return</span> search($(document.body), height);
  };

  elementFinder.pixelForPosition = <span class="function"><span class="keyword">function</span> <span class="params">(position)</span> {</span>
    <span class="comment">/* Inverse of elementFinder.elementByPixel */</span>
    <span class="keyword">if</span> (position.location == <span class="string">"body"</span>) {
      <span class="keyword">return</span> position.offset;
    }
    <span class="keyword">var</span> el;
    <span class="keyword">try</span> {
      el = elementFinder.findElement(position.location);
    } <span class="keyword">catch</span> (e) {
      <span class="keyword">if</span> (e <span class="keyword">instanceof</span> elementFinder.CannotFind &amp;&amp; position.absoluteTop) {</pre></div></div>
              
            </li>
          
            <li id="section-7">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-7">&#182;</a>
                </div>
                <p>We don&#39;t trust absoluteTop to be quite right locally, so we adjust
for the total document height differences:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> percent = position.absoluteTop / position.documentHeight;
        <span class="keyword">return</span> $(document).height() * percent;
      }
      <span class="keyword">throw</span> e;
    }
    <span class="keyword">var</span> top = $(el).offset().top;</pre></div></div>
              
            </li>
          
            <li id="section-8">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-8">&#182;</a>
                </div>
                <p>FIXME: maybe here we should test for sanity, like if an element is
hidden.  We can use position.absoluteTop to get a sense of where the
element roughly should be.  If the sanity check failed we&#39;d use
absoluteTop</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> top + position.offset;
  };

  <span class="keyword">return</span> elementFinder;

});</pre></div></div>
              
            </li>
          
        </ul>
      </div>
    </section>






        <hr>

        <footer>

          <section class="row" id="footer">
            <div class="col-xs-3 text-left">
              <p><a href="https://mozillalabs.com/en-US/" target="_blank"><img src="../images/footer-mozilla-labs.png"></a></p>
            </div>
            <div class="col-xs-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href=".././" class="scrollnav">Overview</a></li>
                <li><a href=".././docs/" target="_blank">Docs</a></li>
                <li class=""><a href="https://github.com/mozilla/togetherjs" target="_blank">Github</a></li>
                <li class=""><a href="mailto:togetherjs@mozilla.com" target="_blank">Contact</a></li>
              </ul>
            </div>
            <div class="col-xs-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href="https://mozillalabs.com/en-US/togetherjs/" target="_blank">About</a></li>
                <li><a href=".././docs/contributing.html">Contributing</a></li>
                <li><a href="../source/">Source Code</a></li>
                <li><a href="../faq.html">FAQ</a></li>
                <li class=""><a href="https://twitter.com/togetherjs" target="_blank">Twitter</a></li>
              </ul>
            </div>
            <div class="col-xs-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href="https://www.mozilla.org/en-US/privacy-policy.html" target="_blank">Privacy Policy</a></li>
                <li class=""><a href="https://www.mozilla.org/en-US/about/legal.html" target="_blank">Legal Notices</a></li>
                <li class=""><a href="https://www.mozilla.org/en-US/legal/fraud-report/index.html" target="_blank">Report Trademark Abuses</a></li>
              </ul>
            </div>
          </section>
        </footer>
      </section>

    </div> <!-- /container -->

  </body>
</html>
