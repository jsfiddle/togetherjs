<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <title>
      Mozilla Labs : TogetherJS
    </title>
    <meta name="viewport" content="width=320, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <meta name="description" content="Real time collaboration features for your website or app.">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../images/fav-icon.ico">

    <script src="../js/jquery-1.10.2.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/parallax.js"></script>
    <script src="../js/custom.js"></script>
    <script src="../js/scrollTo.js"></script>
    <script src="../js/scrollspy.js"></script>
    <script src="../js/waypoints.min.js"></script>
    <script src="../js/how-animations.js"></script>
    <script src="../togetherjs.js"></script>

    <!-- retina library -->
    <script src="../js/retina.js"></script>

    <script src="//mozorg.cdn.mozilla.net/tabzilla/tabzilla.js"></script>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-35433268-28']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>

    <!-- Bootstrap core CSS -->
    <link href="../css/bootstrap.css" rel="stylesheet">
    <link href="../css/jumbotron.css" rel="stylesheet">
    <link href="../css/carousel.css" rel="stylesheet">
    <link href="../css/grid.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <link href="//mozorg.cdn.mozilla.net/media/css/tabzilla-min.css" rel="stylesheet" />

    
  <link rel="stylesheet" href="../css/docco.css">
  <script src="../js/source-code.js"></script>


    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js">
      </script>
    <![endif]-->
    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="../assets/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">

  </head>
  <body >
    <div class="navbar navbar-inverse navbar-fixed-top main-header" id="main-navbar">

      <!-- Tabzilla -->
      <a href="https://www.mozilla.org/" id="tabzilla">mozilla</a>

      <!-- start container -->
      <div class="container navbox">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand main-logo scrollnav" href=".././"></a>
          <a class="navbar-brand masthead-title" href=".././">TogetherJS</a>
        </div>

        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right main-nav">
            <li><a href=".././"  >Overview</a></li>
            <li><a href=".././docs/"  >Documentation</a></li>
            <li><a href="https://github.com/mozilla/togetherjs" target="_blank">Github</a></li>
            <li><a href="mailto:togetherjs@mozilla.com">Contact</a></li>
          </ul>
        </div><!--/.navbar-collapse -->

      </div>
    </div>


    

<div class="container">

    <section class="row" id="sourcecode">
      <div class="col-md-3" id="source-toc">
        <div class="panel" role="complementary" data-spy="affix" data-offset-top="200" id="sidenav">
          <div class="panel-heading">Source Code</div>
          <ul class="nav" id="sectionmenu">
            
              <li><a href="analytics.js.html">analytics</a></li>
            
              <li><a href="channels.js.html">channels</a></li>
            
              <li><a href="chat.js.html">chat</a></li>
            
              <li><a href="cursor.js.html">cursor</a></li>
            
              <li><a href="elementFinder.js.html">elementFinder</a></li>
            
              <li><a href="eventMaker.js.html">eventMaker</a></li>
            
              <li><a href="forms.js.html">forms</a></li>
            
              <li><a href="jqueryPlugins.js.html">jqueryPlugins</a></li>
            
              <li><a href="linkify.js.html">linkify</a></li>
            
              <li><a href="ot.js.html">ot</a></li>
            
              <li><a href="peers.js.html">peers</a></li>
            
              <li><a href="playback.js.html">playback</a></li>
            
              <li><a href="randomutil.js.html">randomutil</a></li>
            
              <li><a href="recorder.js.html">recorder</a></li>
            
              <li><a href="session.js.html">session</a></li>
            
              <li><a href="startup.js.html">startup</a></li>
            
              <li><a href="storage.js.html">storage</a></li>
            
              <li><a href="templates.js.html">templates</a></li>
            
              <li><a href="templating.js.html">templating</a></li>
            
              <li><a href="togetherjs.js.html">togetherjs</a></li>
            
              <li><a href="ui.js.html">ui</a></li>
            
              <li><a href="util.js.html">util</a></li>
            
              <li><a href="videos.js.html">videos</a></li>
            
              <li><a href="visibilityApi.js.html">visibilityApi</a></li>
            
              <li><a href="walkthrough.js.html">walkthrough</a></li>
            
              <li><a href="webrtc.js.html">webrtc</a></li>
            
              <li><a href="who.js.html">who</a></li>
            
              <li><a href="windowing.js.html">windowing</a></li>
            
          </ul>
        </div>
      </div>

      <div class="col-md-9" id="source-content">
        <h1>session.js</h1>
        
          <h4><p>The most important and most core module in the system.  This sets up the channels, routes messages, tracks peers, and is used for inter-module communication using events.</p>
</h4>
        

        <div class="small"><a href="https://github.com/mozilla/togetherjs/blob/develop/togetherjs/session.js">See this file on Github</a></div>

        <ul class="sections">
          
            <li id="section-0">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-0">&#182;</a>
                </div>
                
              </div>
              
                <div class="content"><div class='highlight'><pre><span class="comment">/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this file,
 * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>

define([<span class="string">"require"</span>, <span class="string">"util"</span>, <span class="string">"channels"</span>, <span class="string">"jquery"</span>, <span class="string">"storage"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(require, util, channels, $, storage)</span> {</span>

  <span class="keyword">var</span> DEBUG = <span class="literal">true</span>;</pre></div></div>
              
            </li>
          
            <li id="section-1">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-1">&#182;</a>
                </div>
                <p>This is the amount of time in which a hello-back must be received after a hello
for us to respect a URL change:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> HELLO_BACK_CUTOFF = <span class="number">1500</span>;

  <span class="keyword">var</span> session = util.mixinEvents(util.Module(<span class="string">"session"</span>));
  <span class="keyword">var</span> assert = util.assert;</pre></div></div>
              
            </li>
          
            <li id="section-2">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-2">&#182;</a>
                </div>
                <p>We will load this module later (there&#39;s a circular import):</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> peers;</pre></div></div>
              
            </li>
          
            <li id="section-3">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-3">&#182;</a>
                </div>
                <p>This is the hub we connect to:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  session.shareId = <span class="literal">null</span>;</pre></div></div>
              
            </li>
          
            <li id="section-4">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-4">&#182;</a>
                </div>
                <p>This is the ID that identifies this client:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  session.clientId = <span class="literal">null</span>;
  session.router = channels.Router();</pre></div></div>
              
            </li>
          
            <li id="section-5">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-5">&#182;</a>
                </div>
                <p>Indicates if TogetherJS has just started (not continuing from a saved session):</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  session.firstRun = <span class="literal">false</span>;</pre></div></div>
              
            </li>
          
            <li id="section-6">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-6">&#182;</a>
                </div>
                <p>This is the key we use for localStorage:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> localStoragePrefix = <span class="string">"togetherjs."</span>;</pre></div></div>
              
            </li>
          
            <li id="section-7">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-7">&#182;</a>
                </div>
                <p>This is the channel to the hub:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> channel = <span class="literal">null</span>;</pre></div></div>
              
            </li>
          
            <li id="section-8">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-8">&#182;</a>
                </div>
                <p>Setting, essentially global:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  session.AVATAR_SIZE = <span class="number">90</span>;

  <span class="keyword">var</span> MAX_SESSION_AGE = <span class="number">30</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>*<span class="number">1000</span>; <span class="comment">// 30 days</span>

  <span class="comment">/****************************************
   * URLs
   */</span>

  session.hubUrl = <span class="function"><span class="keyword">function</span> <span class="params">(id)</span> {</span>
    id = id || session.shareId;
    assert(id, <span class="string">"URL cannot be resolved before TogetherJS.shareId has been initialized"</span>);
    <span class="keyword">return</span> TogetherJS.getConfig(<span class="string">"hubBase"</span>).replace(<span class="regexp">/\/*$/</span>, <span class="string">""</span>) + <span class="string">"/hub/"</span> + id;
  };

  session.shareUrl = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    assert(session.shareId, <span class="string">"Attempted to access shareUrl() before shareId is set"</span>);
    <span class="keyword">var</span> hash = location.hash;
    <span class="keyword">var</span> m = <span class="regexp">/\?[^#]*/</span>.exec(location.href);
    <span class="keyword">var</span> query = <span class="string">""</span>;
    <span class="keyword">if</span> (m) {
      query = m[<span class="number">0</span>];
    }
    hash = hash.replace(<span class="regexp">/&amp;?togetherjs-[a-zA-Z0-9]+/</span>, <span class="string">""</span>);
    hash = hash || <span class="string">"#"</span>;
    <span class="keyword">return</span> location.protocol + <span class="string">"//"</span> + location.host + location.pathname + query +
           hash + <span class="string">"&amp;togetherjs="</span> + session.shareId;
  };

  session.recordUrl = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    assert(session.shareId);
    <span class="keyword">var</span> url = TogetherJS.baseUrl.replace(<span class="regexp">/\/*$/</span>, <span class="string">""</span>) + <span class="string">"/recorder.html"</span>;
    url += <span class="string">"#&amp;togetherjs="</span> + session.shareId + <span class="string">"&amp;hubBase="</span> + TogetherJS.getConfig(<span class="string">"hubBase"</span>);
    <span class="keyword">return</span> url;
  };

  <span class="comment">/* location.href without the hash */</span>
  session.currentUrl = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> location.href.replace(<span class="regexp">/#.*/</span>, <span class="string">""</span>);
  };

  session.siteName = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    <span class="keyword">return</span> TogetherJS.getConfig(<span class="string">"siteName"</span>) || document.title;
  };

  <span class="comment">/****************************************
   * Message handling/dispatching
   */</span>

  session.hub = util.mixinEvents({});

  <span class="keyword">var</span> IGNORE_MESSAGES = [<span class="string">"cursor-update"</span>, <span class="string">"keydown"</span>, <span class="string">"scroll-update"</span>];</pre></div></div>
              
            </li>
          
            <li id="section-9">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-9">&#182;</a>
                </div>
                <p>These are messages sent by clients who aren&#39;t &quot;part&quot; of the TogetherJS session:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> MESSAGES_WITHOUT_CLIENTID = [<span class="string">"who"</span>, <span class="string">"invite"</span>, <span class="string">"init-connection"</span>];</pre></div></div>
              
            </li>
          
            <li id="section-10">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-10">&#182;</a>
                </div>
                <p>We ignore incoming messages from the channel until this is true:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> readyForMessages = <span class="literal">false</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">openChannel</span><span class="params">()</span> {</span>
    assert(! channel, <span class="string">"Attempt to re-open channel"</span>);
    console.info(<span class="string">"Connecting to"</span>, session.hubUrl(), location.href);
    <span class="keyword">var</span> c = channels.WebSocketChannel(session.hubUrl());
    c.onmessage = <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
      <span class="keyword">if</span> (! readyForMessages) {
        <span class="keyword">if</span> (DEBUG) {
          console.info(<span class="string">"In (but ignored for being early):"</span>, msg);
        }
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (DEBUG &amp;&amp; IGNORE_MESSAGES.indexOf(msg.type) == -<span class="number">1</span>) {
        console.info(<span class="string">"In:"</span>, msg);
      }
      <span class="keyword">if</span> (! peers) {</pre></div></div>
              
            </li>
          
            <li id="section-11">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-11">&#182;</a>
                </div>
                <p>We&#39;re getting messages before everything is fully initialized</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        console.warn(<span class="string">"Message received before all modules loaded (ignoring):"</span>, msg);
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> ((! msg.clientId) &amp;&amp; MESSAGES_WITHOUT_CLIENTID.indexOf(msg.type) == -<span class="number">1</span>) {
        console.warn(<span class="string">"Got message without clientId, where clientId is required"</span>, msg);
        <span class="keyword">return</span>;
      }
      <span class="keyword">if</span> (msg.clientId) {
        msg.peer = peers.getPeer(msg.clientId, msg);
      }
      <span class="keyword">if</span> (msg.type == <span class="string">"hello"</span> || msg.type == <span class="string">"hello-back"</span> || msg.type == <span class="string">"peer-update"</span>) {</pre></div></div>
              
            </li>
          
            <li id="section-12">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-12">&#182;</a>
                </div>
                <p>We do this here to make sure this is run before any other
hello handlers:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        msg.peer.updateFromHello(msg);
      }
      <span class="keyword">if</span> (msg.peer) {
        msg.sameUrl = msg.peer.url == currentUrl;
        <span class="keyword">if</span> (!msg.peer.isSelf) {
          msg.peer.updateMessageDate(msg);
        }
      }
      session.hub.emit(msg.type, msg);
      TogetherJS._onmessage(msg);
    };
    channel = c;
    session.router.bindChannel(channel);
  }</pre></div></div>
              
            </li>
          
            <li id="section-13">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-13">&#182;</a>
                </div>
                <p>FIXME: once we start looking at window.history we need to update this:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> currentUrl = (location.href + <span class="string">""</span>).replace(<span class="regexp">/\#.*$/</span>, <span class="string">""</span>);

  session.send = <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (DEBUG &amp;&amp; IGNORE_MESSAGES.indexOf(msg.type) == -<span class="number">1</span>) {
      console.info(<span class="string">"Send:"</span>, msg);
    }
    msg.clientId = session.clientId;
    channel.send(msg);
  };

  session.appSend = <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">var</span> type = msg.type;
    <span class="keyword">if</span> (type.search(<span class="regexp">/^togetherjs\./</span>) === <span class="number">0</span>) {
      type = type.substr(<span class="string">"togetherjs."</span>.length);
    } <span class="keyword">else</span> <span class="keyword">if</span> (type.search(<span class="regexp">/^app\./</span>) === -<span class="number">1</span>) {
      type = <span class="string">"app."</span> + type;
    }
    msg.type = type;
    session.send(msg);
  };

  <span class="comment">/****************************************
   * Standard message responses
   */</span>

  <span class="comment">/* Always say hello back, and keep track of peers: */</span>
  session.hub.on(<span class="string">"hello hello-back"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (msg.type == <span class="string">"hello"</span>) {
      sendHello(<span class="literal">true</span>);
    }
    <span class="keyword">if</span> (session.isClient &amp;&amp; (! msg.isClient) &amp;&amp;
        session.firstRun &amp;&amp; session.timeHelloSent &amp;&amp;
        Date.now() - session.timeHelloSent &lt; HELLO_BACK_CUTOFF) {
      processFirstHello(msg);
    }
  });

  session.hub.on(<span class="string">"who"</span>, <span class="function"><span class="keyword">function</span> <span class="params">(msg)</span> {</span>
    sendHello(<span class="literal">true</span>);
  });

  <span class="function"><span class="keyword">function</span> <span class="title">processFirstHello</span><span class="params">(msg)</span> {</span>
    <span class="keyword">if</span> (! msg.sameUrl) {
      <span class="keyword">var</span> url = msg.url;
      <span class="keyword">if</span> (msg.urlHash) {
        url += msg.urlHash;
      }
      require(<span class="string">"ui"</span>).showUrlChangeMessage(msg.peer, url);
      location.href = url;
    }
  }

  session.timeHelloSent = <span class="literal">null</span>;

  <span class="function"><span class="keyword">function</span> <span class="title">sendHello</span><span class="params">(helloBack)</span> {</span>
    <span class="keyword">var</span> msg = session.makeHelloMessage(helloBack);
    <span class="keyword">if</span> (! helloBack) {
      session.timeHelloSent = Date.now();
      peers.Self.url = msg.url;
    }
    session.send(msg);
  }

  session.makeHelloMessage = <span class="function"><span class="keyword">function</span> <span class="params">(helloBack)</span> {</span>
    <span class="keyword">var</span> msg = {
      name: peers.Self.name || peers.Self.defaultName,
      avatar: peers.Self.avatar,
      color: peers.Self.color,
      url: session.currentUrl(),
      urlHash: location.hash,</pre></div></div>
              
            </li>
          
            <li id="section-14">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-14">&#182;</a>
                </div>
                <p>FIXME: titles update, we should track those changes:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>      title: document.title,
      rtcSupported: session.RTCSupported,
      isClient: session.isClient
    };
    <span class="keyword">if</span> (helloBack) {
      msg.type = <span class="string">"hello-back"</span>;
    } <span class="keyword">else</span> {
      msg.type = <span class="string">"hello"</span>;
      msg.clientVersion = TogetherJS.version;
    }
    <span class="keyword">if</span> (! TogetherJS.startup.continued) {
      msg.starting = <span class="literal">true</span>;
    }</pre></div></div>
              
            </li>
          
            <li id="section-15">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-15">&#182;</a>
                </div>
                <p>This is a chance for other modules to effect the hello message:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>    session.emit(<span class="string">"prepare-hello"</span>, msg);
    <span class="keyword">return</span> msg;
  };

  <span class="comment">/****************************************
   * Lifecycle (start and end)
   */</span></pre></div></div>
              
            </li>
          
            <li id="section-16">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-16">&#182;</a>
                </div>
                <p>These are Javascript files that implement features, and so must
be injected at runtime because they aren&#39;t pulled in naturally
via define().
ui must be the first item:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> features = [<span class="string">"peers"</span>, <span class="string">"ui"</span>, <span class="string">"chat"</span>, <span class="string">"webrtc"</span>, <span class="string">"cursor"</span>, <span class="string">"startup"</span>,<span class="string">"videos"</span>, <span class="string">"forms"</span>, <span class="string">"visibilityApi"</span>];

  <span class="function"><span class="keyword">function</span> <span class="title">getRoomName</span><span class="params">(prefix, maxSize)</span> {</span>
    <span class="keyword">var</span> findRoom = TogetherJS.getConfig(<span class="string">"hubBase"</span>).replace(<span class="regexp">/\/*$/</span>, <span class="string">""</span>) + <span class="string">"/findroom"</span>;
    <span class="keyword">return</span> $.ajax({
      url: findRoom,
      dataType: <span class="string">"json"</span>,
      data: {prefix: prefix, max: maxSize}
    }).then(<span class="function"><span class="keyword">function</span> <span class="params">(resp)</span> {</span>
      <span class="keyword">return</span> resp.name;
    });
  }

  <span class="function"><span class="keyword">function</span> <span class="title">initIdentityId</span><span class="params">()</span> {</span>
    <span class="keyword">return</span> util.Deferred(<span class="function"><span class="keyword">function</span> <span class="params">(def)</span> {</span>
      <span class="keyword">if</span> (session.identityId) {
        def.resolve();
        <span class="keyword">return</span>;
      }
      storage.get(<span class="string">"identityId"</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(identityId)</span> {</span>
        <span class="keyword">if</span> (! identityId) {
          identityId = util.generateId();
          storage.set(<span class="string">"identityId"</span>, identityId);
        }
        session.identityId = identityId;</pre></div></div>
              
            </li>
          
            <li id="section-17">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-17">&#182;</a>
                </div>
                <p>We don&#39;t actually have to wait for the set to succede, so
long as session.identityId is set</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        def.resolve();
      });
    });
  }

  initIdentityId.done = initIdentityId();

  <span class="function"><span class="keyword">function</span> <span class="title">initShareId</span><span class="params">()</span> {</span>
    <span class="keyword">return</span> util.Deferred(<span class="function"><span class="keyword">function</span> <span class="params">(def)</span> {</span>
      <span class="keyword">var</span> hash = location.hash;
      <span class="keyword">var</span> shareId = session.shareId;
      <span class="keyword">var</span> isClient = <span class="literal">true</span>;
      <span class="keyword">var</span> set = <span class="literal">true</span>;
      <span class="keyword">var</span> sessionId;
      session.firstRun = ! TogetherJS.startup.continued;
      <span class="keyword">if</span> (! shareId) {
        <span class="keyword">if</span> (TogetherJS.startup._joinShareId) {</pre></div></div>
              
            </li>
          
            <li id="section-18">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-18">&#182;</a>
                </div>
                <p>Like, below, this <em>also</em> means we got the shareId from the hash
(in togetherjs.js):</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>          shareId = TogetherJS.startup._joinShareId;
        }
      }
      <span class="keyword">if</span> (! shareId) {</pre></div></div>
              
            </li>
          
            <li id="section-19">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-19">&#182;</a>
                </div>
                <p>FIXME: I&#39;m not sure if this will ever happen, because togetherjs.js should
handle it</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> m = <span class="regexp">/&amp;?togetherjs=([^&amp;]*)/</span>.exec(hash);
        <span class="keyword">if</span> (m) {
          isClient = ! m[<span class="number">1</span>];
          shareId = m[<span class="number">2</span>];
          <span class="keyword">var</span> newHash = hash.substr(<span class="number">0</span>, m.index) + hash.substr(m.index + m[<span class="number">0</span>].length);
          location.hash = newHash;
        }
      }
      <span class="keyword">return</span> storage.tab.get(<span class="string">"status"</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(saved)</span> {</span>
        <span class="keyword">var</span> findRoom = TogetherJS.getConfig(<span class="string">"findRoom"</span>);
        <span class="keyword">if</span> (findRoom &amp;&amp; <span class="keyword">typeof</span> findRoom == <span class="string">"string"</span> &amp;&amp; ! saved) {
          isClient = <span class="literal">true</span>;
          shareId = findRoom;
          sessionId = util.generateId();
        } <span class="keyword">else</span> <span class="keyword">if</span> (findRoom &amp;&amp; ! saved) {
          assert(findRoom.prefix &amp;&amp; <span class="keyword">typeof</span> findRoom.prefix == <span class="string">"string"</span>, <span class="string">"Bad findRoom.prefix"</span>, findRoom);
          assert(findRoom.max &amp;&amp; <span class="keyword">typeof</span> findRoom.max == <span class="string">"number"</span> &amp;&amp; findRoom.max &gt; <span class="number">0</span>,
                 <span class="string">"Bad findRoom.max"</span>, findRoom);
          sessionId = util.generateId();
          <span class="keyword">if</span> (findRoom.prefix.search(<span class="regexp">/[^a-zA-Z0-9]/</span>) != -<span class="number">1</span>) {
            console.warn(<span class="string">"Bad value for findRoom.prefix:"</span>, JSON.stringify(findRoom.prefix));
          }
          getRoomName(findRoom.prefix, findRoom.max).then(<span class="function"><span class="keyword">function</span> <span class="params">(shareId)</span> {</span></pre></div></div>
              
            </li>
          
            <li id="section-20">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-20">&#182;</a>
                </div>
                <p>FIXME: duplicates code below:</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>            session.clientId = session.identityId + <span class="string">"."</span> + sessionId;
            storage.tab.set(<span class="string">"status"</span>, {reason: <span class="string">"joined"</span>, shareId: shareId, running: <span class="literal">true</span>, date: Date.now(), sessionId: sessionId});
            session.isClient = <span class="literal">true</span>;
            session.shareId = shareId;
            session.emit(<span class="string">"shareId"</span>);
            def.resolve(session.shareId);
          });
          <span class="keyword">return</span>;
        } <span class="keyword">else</span> <span class="keyword">if</span> (TogetherJS.startup._launch) {
          <span class="keyword">if</span> (saved) {
            isClient = saved.reason == <span class="string">"joined"</span>;
            <span class="keyword">if</span> (! shareId) {
              shareId = saved.shareId;
            }
            sessionId = saved.sessionId;
          } <span class="keyword">else</span> {
            isClient = TogetherJS.startup.reason == <span class="string">"joined"</span>;
            assert(! sessionId);
            sessionId = util.generateId();
          }
          <span class="keyword">if</span> (! shareId) {
            shareId = util.generateId();
          }
        } <span class="keyword">else</span> <span class="keyword">if</span> (saved) {
          isClient = saved.reason == <span class="string">"joined"</span>;
          TogetherJS.startup.reason = saved.reason;
          TogetherJS.startup.continued = <span class="literal">true</span>;
          shareId = saved.shareId;
          sessionId = saved.sessionId;</pre></div></div>
              
            </li>
          
            <li id="section-21">
              <div class="annotation">
                <div class="pilwrap">
                  <a class="pilcrow" href="#section-21">&#182;</a>
                </div>
                <p>The only case when we don&#39;t need to set the storage status again is when
we&#39;re already set to be running</p>

              </div>
              
                <div class="content"><div class='highlight'><pre>          set = ! saved.running;
        } <span class="keyword">else</span> {
          <span class="keyword">throw</span> <span class="keyword">new</span> util.AssertionError(<span class="string">"No saved status, and no startup._launch request; why did TogetherJS start?"</span>);
        }
        assert(session.identityId);
        session.clientId = session.identityId + <span class="string">"."</span> + sessionId;
        <span class="keyword">if</span> (set) {
          storage.tab.set(<span class="string">"status"</span>, {reason: TogetherJS.startup.reason, shareId: shareId, running: <span class="literal">true</span>, date: Date.now(), sessionId: sessionId});
        }
        session.isClient = isClient;
        session.shareId = shareId;
        session.emit(<span class="string">"shareId"</span>);
        def.resolve(session.shareId);
      });
    });
  }

  <span class="function"><span class="keyword">function</span> <span class="title">initStartTarget</span><span class="params">()</span> {</span>
    <span class="keyword">var</span> id;
    <span class="keyword">if</span> (TogetherJS.startup.button) {
      id = TogetherJS.startup.button.id;
      <span class="keyword">if</span> (id) {
        storage.set(<span class="string">"startTarget"</span>, id);
      }
      <span class="keyword">return</span>;
    }
    storage.get(<span class="string">"startTarget"</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(id)</span> {</span>
      <span class="keyword">var</span> el = document.getElementById(id);
      <span class="keyword">if</span> (el) {
        TogetherJS.startup.button = el;
      }
    });
  }

  session.start = <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    initStartTarget();
    initIdentityId().then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      initShareId().then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
        readyForMessages = <span class="literal">false</span>;
        openChannel();
        require([<span class="string">"ui"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(ui)</span> {</span>
          TogetherJS.running = <span class="literal">true</span>;
          ui.prepareUI();
          require(features, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
            $(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
              peers = require(<span class="string">"peers"</span>);
              <span class="keyword">var</span> startup = require(<span class="string">"startup"</span>);
              session.emit(<span class="string">"start"</span>);
              session.once(<span class="string">"ui-ready"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                readyForMessages = <span class="literal">true</span>;
                startup.start();
              });
              ui.activateUI();
              <span class="keyword">if</span> (TogetherJS.getConfig(<span class="string">"enableAnalytics"</span>)) {
                require([<span class="string">"analytics"</span>], <span class="function"><span class="keyword">function</span> <span class="params">(analytics)</span> {</span>
                  analytics.activate();
                });
              }
              peers._SelfLoaded.then(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
                sendHello(<span class="literal">false</span>);
              });
              TogetherJS.emit(<span class="string">"ready"</span>);
            });
          });
        });
      });
    });
  };

  session.close = <span class="function"><span class="keyword">function</span> <span class="params">(reason)</span> {</span>
    TogetherJS.running = <span class="literal">false</span>;
    <span class="keyword">var</span> msg = {type: <span class="string">"bye"</span>};
    <span class="keyword">if</span> (reason) {
      msg.reason = reason;
    }
    session.send(msg);
    session.emit(<span class="string">"close"</span>);
    <span class="keyword">var</span> name = window.name;
    storage.tab.get(<span class="string">"status"</span>).then(<span class="function"><span class="keyword">function</span> <span class="params">(saved)</span> {</span>
      <span class="keyword">if</span> (! saved) {
        console.warn(<span class="string">"No session information saved in"</span>, <span class="string">"status."</span> + name);
      } <span class="keyword">else</span> {
        saved.running = <span class="literal">false</span>;
        saved.date = Date.now();
        storage.tab.set(<span class="string">"status"</span>, saved);
      }
      channel.close();
      channel = <span class="literal">null</span>;
      session.shareId = <span class="literal">null</span>;
      session.emit(<span class="string">"shareId"</span>);
      TogetherJS.emit(<span class="string">"close"</span>);
      TogetherJS._teardown();
    });
  };


  session.on(<span class="string">"start"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    $(window).on(<span class="string">"resize"</span>, resizeEvent);
  });
  session.on(<span class="string">"close"</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
    $(window).off(<span class="string">"resize"</span>, resizeEvent);
  });
  <span class="function"><span class="keyword">function</span> <span class="title">resizeEvent</span><span class="params">()</span> {</span>
    session.emit(<span class="string">"resize"</span>);
  }

  <span class="keyword">if</span> (TogetherJS.startup._launch) {
    setTimeout(session.start);
  }

  util.testExpose({
    getChannel: <span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
      <span class="keyword">return</span> channel;
    }
  });

  <span class="keyword">return</span> session;
});</pre></div></div>
              
            </li>
          
        </ul>
      </div>
    </section>






        <hr>

        <footer>

          <section class="row" id="footer">
            <div class="col-xs-3 text-left">
              <p><a href="https://mozillalabs.com/en-US/" target="_blank"><img src="../images/footer-mozilla-labs.png"></a></p>
            </div>
            <div class="col-xs-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href=".././" class="scrollnav">Overview</a></li>
                <li><a href=".././docs/" target="_blank">Docs</a></li>
                <li class=""><a href="https://github.com/mozilla/togetherjs" target="_blank">Github</a></li>
                <li class=""><a href="mailto:togetherjs@mozilla.com" target="_blank">Contact</a></li>
              </ul>
            </div>
            <div class="col-xs-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href="https://mozillalabs.com/en-US/togetherjs/" target="_blank">About</a></li>
                <li><a href=".././docs/contributing.html">Contributing</a></li>
                <li><a href="../source/">Source Code</a></li>
                <li><a href="../faq.html">FAQ</a></li>
                <li class=""><a href="https://twitter.com/togetherjs" target="_blank">Twitter</a></li>
              </ul>
            </div>
            <div class="col-xs-3">
              <ul class="list-unstyled text-left">
                <li class=""><a href="https://www.mozilla.org/en-US/privacy-policy.html" target="_blank">Privacy Policy</a></li>
                <li class=""><a href="https://www.mozilla.org/en-US/about/legal.html" target="_blank">Legal Notices</a></li>
                <li class=""><a href="https://www.mozilla.org/en-US/legal/fraud-report/index.html" target="_blank">Report Trademark Abuses</a></li>
              </ul>
            </div>
          </section>
        </footer>
      </section>

    </div> <!-- /container -->

  </body>
</html>
