<!DOCTYPE html>
<meta charset="utf-8">
<title>Slowparse Error Reporting Specification</title>
<style>
html, body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  font-size: small;
}

body {
  width: 800px;
  margin: 0 auto 1em auto;
}

div.report > h2:before {
  content: "ERROR TYPE: ";
  color: gray;
}

pre, div.js {
  font-family: Menlo, Monaco, "Lucida Console", monospace;
}

div.console {
  background: black;
  padding: 10px;
}

div.js {
  color: lightgreen;
}

div.js > div {
  display: pre;
}

div.js > div:before {
  content: '> ';
  color: gray;
}

pre.result {
  color: lightgray;
}

pre.html {
  background: #f0f0f0;
  color: black;
  padding: 10px;
}

.color-1 {
  background: pink;
}

.color-2 {
  background: black;
  color: white;
}

.error em {
  font-style: inherit;
}
</style>
<h1>Slowparse Error Reporting Specification</h1>
<div id="templates" style="display: none">
  <div class="report">
    <h2></h2>
    <h3>Example</h3>
    <pre class="html"></pre>
    <div class="error"></div>
    <h3>JavaScript Code</h3>
    <div class="console">
      <div class="js">
        <div>Slowparse.findError({{HTML}});</div>
      </div>
      <pre class="result"></pre>
    </div>
  </div>
  <div class="error-msgs"></div>
</div>
<script type="text/x-bad-html">
  <p>hi</i>
</script>
<script type="text/x-bad-html">
  hello <em>there
</script>
<script type="text/x-bad-html">
  <-lol>
</script>
<script src="jquery.min.js"></script>
<script src="underscore.min.js"></script>
<script src="../slowparse.js"></script>
<script>
_.templateSettings = {
  escape: /\{\{(.+?)\}\}/g
};

jQuery.fn.extend({
  showHighlights: function(source) {
    function sourceText(interval) {
      return source.text().slice(interval.start, interval.end);
    }
    
    var newSource = $("<div></div>"),
        slices = [],
        i = 0;
    this.find("[data-highlight]").each(function(n) {
      var parts = $(this).attr("data-highlight").split(",");
      slices.push({
        start: parseInt(parts[0]),
        end: parseInt(parts[1]),
        linkedNode: this
      });
      $(this).attr("class", "color-" + (n + 1));
    });
    slices.sort(function(a, b) { return a.start - b.start; });
    jQuery.each(slices, function(n, slice) {
      var color = $(slice.linkedNode).attr("class"),
          span = $("<span></span>");
      if (slice.start > i) {
        newSource.append(document.createTextNode(sourceText({
          start: i,
          end: slice.start
        })));
      }
      span.addClass(color)
        .text(sourceText(slice))
        .appendTo(newSource);
      i = slice.end;
    });
    if (i < source.text().length) {
      newSource.append(document.createTextNode(sourceText({
        start: i,
        end: undefined
      })));
    }
    source.html(newSource.html());
    return this;
  }
});

$(window).ready(function() {
  $("#templates .error-msgs").load("error-msgs.html", function() {
    $('script[type="text/x-bad-html"]').each(function() {
      var badHtml = $(this).text().trim();
      var error = Slowparse.HTML(document, badHtml).error;
      var t = $("#templates .report").clone();
      var js = $(".js > div:first-child", t).text();
    
      js = js.replace("{{HTML}}", JSON.stringify(badHtml));

      $(".js > div:first-child", t).text(js);
      $("h2", t).text(error.type);
      $(".html", t).text(badHtml);
      $(".result", t).text(JSON.stringify(error, null, "  "));

      var errMsg = $("#templates .error-msg." + error.type);
      if (errMsg.length) {
        $(".error", t).html(_.template(errMsg.html(), error))
          .showHighlights($(".html", t));
      } else
        $(".error", t).text("ERROR: No error message available.");

      $(this).replaceWith(t);
    });
  });
});
</script>
